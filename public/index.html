<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fr8Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui,Arial,sans-serif;background:#0b1220;color:#e6edf3;margin:0}
    a{color:#6ab0ff}
    .wrap{max-width:980px;margin:80px auto 120px;padding:0 16px}
    h1{font-size:28px;margin:0 0 12px}
    h2{font-size:18px;margin:20px 0 8px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin:12px 0 28px}
    .card{background:#111a2e;border:1px solid #223;border-radius:12px;padding:12px}
    .loginbar{position:fixed;inset:auto 0 0 0;background:#0b1220;padding:10px;border-top:1px solid #223;display:flex;gap:8px;align-items:center;z-index:9999}
    input,button,textarea{border-radius:8px;border:1px solid #334;background:#0f1730;color:#e6edf3}
    input,button{padding:8px}
    textarea{width:100%;min-height:120px;padding:10px}
    .btn{cursor:pointer}
    .out{white-space:pre-wrap;background:#0f1730;border:1px solid #334;border-radius:8px;padding:12px;margin-top:10px}
    .muted{opacity:.8;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fr8Coach</h1>
    <p class="muted">Protected by a site password. Enter it below once, then refresh cards or ask the coach.</p>

    <h2>Sales Cards</h2>
    <div id="sales" class="cards"></div>

    <h2>Ops Cards</h2>
    <div id="ops" class="cards"></div>

    <h2>Coach</h2>
    <textarea id="q" placeholder="e.g., Draft a first-meeting agenda for a 1-lane trial with a big-box retailer."></textarea>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button id="ask" class="btn">Ask</button>
      <button id="refresh" class="btn">Refresh Cards</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="reply" class="out" style="margin-top:12px"></div>
  </div>

  <!-- Password bar (no email) -->
  <div class="loginbar">
    <strong>Site Password</strong>
    <input id="fc-pw" type="password" placeholder="Enter site password" style="flex:1;min-width:260px" />
    <button id="fc-save" class="btn">Save</button>
    <button id="fc-clear" class="btn" title="Clear saved password">Clear</button>
  </div>

  <script>
    // ---- Persist ONLY the site password (no email) ----
    const pwEl    = document.getElementById('fc-pw');
    const saveBtn = document.getElementById('fc-save');
    const clearBtn= document.getElementById('fc-clear');
    const statusEl= document.getElementById('status');

    // restore saved
    const savedPW = localStorage.getItem('FR8COACH_PW') || '';
    if (savedPW) pwEl.value = savedPW;

    saveBtn.onclick = () => {
      const pw = (pwEl.value || '').trim();
      if (!pw) return alert('Enter the site password.');
      localStorage.setItem('FR8COACH_PW', pw);
      alert('Password saved.');
      loadCards();
    };
    clearBtn.onclick = () => {
      localStorage.removeItem('FR8COACH_PW');
      pwEl.value = '';
      alert('Saved password cleared.');
    };

    // ---- Helper: fetch JSON with password header ----
    async function api(path, opts = {}) {
      const pw = localStorage.getItem('FR8COACH_PW') || '';
      const headers = Object.assign({'Content-Type':'application/json','x-site-password': pw}, opts.headers||{});
      const r = await fetch(path, Object.assign({}, opts, { headers }));
      if (!r.ok) {
        const txt = await r.text().catch(()=> '');
        throw new Error(`HTTP ${r.status}${txt ? ' – ' + txt : ''}`);
      }
      return r.json();
    }

    // ---- Load Sales & Ops cards ----
    async function loadCards() {
      const salesEl = document.getElementById('sales');
      const opsEl   = document.getElementById('ops');
      salesEl.innerHTML = '<div class="card">Loading…</div>';
      opsEl.innerHTML   = '<div class="card">Loading…</div>';
      try {
        const [sales, ops] = await Promise.all([
          api('/api/cards?type=sales'),
          api('/api/cards?type=ops')
        ]);
        renderCards('sales', sales.cards || []);
        renderCards('ops',   ops.cards   || []);
        statusEl.textContent = '';
      } catch (e) {
        console.error(e);
        salesEl.innerHTML = '<div class="card">Failed to load sales cards (check password)</div>';
        opsEl.innerHTML   = '<div class="card">Failed to load ops cards (check password)</div>';
        statusEl.textContent = 'Unauthorized? Make sure the site password is saved.';
      }
    }

    function renderCards(id, cards) {
      const el = document.getElementById(id);
      el.innerHTML = (cards && cards.length)
        ? cards.map(c => `
            <div class="card">
              <div><strong>${escapeHtml(c.title || c.header || 'Card')}</strong></div>
              <div>${escapeHtml(c.body || c.content || '')}</div>
            </div>
          `).join('')
        : '<div class="card">No cards yet</div>';
    }

    function escapeHtml(s){return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}

    document.getElementById('refresh').onclick = loadCards;

    // ---- Ask coach (no email sent) ----
    document.getElementById('ask').onclick = async () => {
      const prompt = document.getElementById('q').value.trim();
      const pw = localStorage.getItem('FR8COACH_PW') || '';
      if (!pw) return alert('Save the site password first.');
      const out = document.getElementById('reply');
      out.textContent = 'Thinking…';
      statusEl.textContent = '';
      try {
        const data = await api('/api/coach', {
          method: 'POST',
          body: JSON.stringify({ prompt })
        });
        out.textContent = (data && data.reply) ? data.reply : JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error: ' + e.message;
        if (/401/.test(e.message)) statusEl.textContent = 'Unauthorized. Check the saved site password.';
      }
    };

    // Initial load
    loadCards();
  </script>
</body>
</html>
