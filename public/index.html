<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fr8 Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Typography + layout */
    :root {
      --bg: #0b0c10;
      --card: #121319;
      --muted: #8a8f98;
      --fg: #e9eef5;
      --accent: #6ea8fe;
      --accent-2: #9fd3c7;
      --border: #232634;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Aptos Mono", "Open Sans", sans-serif;
      line-height: 1.45;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px 64px;
    }
    .container {
      width: 100%;
      max-width: 980px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 18px;
    }
    .title {
      margin: 0 0 6px 0;
      font-weight: 700;
      letter-spacing: 0.4px;
      font-size: clamp(26px, 4vw, 36px);
    }
    .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      letter-spacing: 0.3px;
      text-transform: none;
    }

    /* Panels */
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
    }

    /* Gate (password) */
    .gate {
      display: grid;
      gap: 10px;
      max-width: 520px;
      margin: 24px auto 0 auto;
      padding: 22px 16px;
    }
    .gate label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }
    input[type="password"], input[type="text"], textarea {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1117;
      color: var(--fg);
      font-size: 14px;
      outline: none;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.35;
      white-space: pre-line;
    }
    button {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #171a22;
      color: var(--fg);
      font-size: 14px;
      cursor: pointer;
    }
    button.primary {
      background: var(--accent);
      color: #0b1020;
      border-color: #4f85e9;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.05); }
    .muted { color: var(--muted); font-size: 13px; }

    /* Coach */
    .coach-grid {
      display: grid;
      gap: 12px;
    }
    .transcript {
      background: #0f1117;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      max-height: 420px;
      overflow: auto;
      display: grid;
      gap: 10px;
    }
    .msg {
      display: inline-block;
      max-width: 95%;
      padding: 10px 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.45;
      font-size: 14px;
    }
    .msg.user { background: #152238; color: #e9f0ff; justify-self: end; text-align: left; }
    .msg.ai   { background: #131720; color: #e9eef5; justify-self: start; text-align: left; }
    .coach-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .links a {
      color: var(--accent-2);
      text-decoration: none;
      padding: 8px 10px;
      border-radius: 10px;
      background: #10211f;
      border: 1px solid #1d3a35;
      font-size: 14px;
    }
    .links a:hover { filter: brightness(1.08); }

    .hidden { display: none; }
    .error { color: #ff9c9c; }
    .ok    { color: #9fe5bf; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="title">Fr8 Coach</h1>
      <p class="subtitle">your personal ai freight-bot</p>
    </header>

    <!-- Password Gate -->
    <section id="gatePanel" class="panel">
      <div class="gate">
        <div class="muted">Enter site password to continue</div>
        <div class="row">
          <input id="sitePass" type="password" placeholder="Site password" autocomplete="off" />
          <button class="primary" id="enterBtn">Enter</button>
        </div>
        <div id="gateMsg" class="muted"></div>
      </div>
    </section>

    <!-- Coach Panel (hidden until authed) -->
    <section id="coachPanel" class="panel hidden">
      <div class="coach-grid">
        <!-- Intake -->
        <div>
          <label class="muted" for="prompt">Ask the Coach</label>
          <textarea id="prompt" placeholder="Ask the Coach a question...
ex) what is a good social selling strategy to help get set up with Home Depot?
ex) send me leads"></textarea>
          <div class="coach-actions">
            <button class="primary" id="askBtn">Ask</button>
            <button id="clearBtn" title="Clear conversation">Clear conversation</button>
          </div>
        </div>

        <!-- Transcript -->
        <div id="transcript" class="transcript" aria-live="polite" aria-label="Conversation transcript"></div>

        <!-- Links to cards -->
        <div class="links">
          <a href="/sales.html">Sales Cards</a>
          <a href="/ops.html">Ops Cards</a>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== State =====
    let SITE_PASSWORD = null;
    let history = []; // {role: 'user'|'assistant', content: '...'}

    const el = (id) => document.getElementById(id);
    const gatePanel    = el("gatePanel");
    const coachPanel   = el("coachPanel");
    const sitePass     = el("sitePass");
    const enterBtn     = el("enterBtn");
    const gateMsg      = el("gateMsg");
    const promptEl     = el("prompt");
    const askBtn       = el("askBtn");
    const clearBtn     = el("clearBtn");
    const transcriptEl = el("transcript");

    // ===== Helpers =====
    function addMsg(role, content) {
      history.push({ role, content });
      const div = document.createElement("div");
      div.className = `msg ${role === "assistant" ? "ai" : "user"}`;
      div.textContent = content;
      transcriptEl.appendChild(div);
      transcriptEl.scrollTop = transcriptEl.scrollHeight;
    }

    function setAuthedUI(on) {
      gatePanel.classList.toggle("hidden", on);
      coachPanel.classList.toggle("hidden", !on);
    }

    async function checkPassword(pw) {
      try {
        const r = await fetch("/api/ping", {
          headers: { "x-site-password": pw || "" }
        });
        if (!r.ok) return false;
        const d = await r.json();
        return !!d.ok;
      } catch {
        return false;
      }
    }

    // ===== Gate actions =====
    enterBtn.addEventListener("click", async () => {
      const pw = sitePass.value.trim();
      gateMsg.textContent = "Checking...";
      const ok = await checkPassword(pw);
      if (!ok) {
        gateMsg.textContent = "Invalid password.";
        gateMsg.className = "error";
        return;
      }
      SITE_PASSWORD = pw; // keep only in-memory (not persisted)
      gateMsg.textContent = "";
      setAuthedUI(true);
      promptEl.focus();
    });

    sitePass.addEventListener("keydown", (e) => {
      if (e.key === "Enter") enterBtn.click();
    });

    // ===== Coach actions =====
    askBtn.addEventListener("click", async () => {
      const q = promptEl.value.trim();
      if (!q) return;
      addMsg("user", q);
      promptEl.value = "";

      try {
        const r = await fetch("/api/coach", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-site-password": SITE_PASSWORD || ""
          },
          body: JSON.stringify({ prompt: q, history })
        });
        const data = await r.json();
        if (data && data.reply) {
          addMsg("assistant", data.reply);
        } else if (data && data.error) {
          addMsg("assistant", `Error: ${data.error}`);
        } else {
          addMsg("assistant", "No reply.");
        }
      } catch (err) {
        addMsg("assistant", "Network error.");
      }
    });

    promptEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        askBtn.click();
      }
    });

    clearBtn.addEventListener("click", () => {
      history = [];
      transcriptEl.innerHTML = "";
    });
  </script>
</body>
</html>
