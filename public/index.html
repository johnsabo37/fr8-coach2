<<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fr8 Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Minimal styling, uses browser/system fonts to avoid changing your look */
    :root {
      --bg: #0b0c10;
      --card: #121319;
      --muted: #8a8f98;
      --fg: #e9eef5;
      --accent: #6ea8fe;
      --border: #232634;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.45;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 32px 16px 64px;
    }
    .container { width: 100%; max-width: 980px; }
    .header { text-align: center; margin-bottom: 18px; }
    .title { margin: 0 0 6px 0; font-weight: 700; letter-spacing: 0.4px; font-size: clamp(26px, 4vw, 36px); }
    .subtitle { margin: 0; color: var(--muted); font-size: 14px; letter-spacing: 0.3px; }
    .panel { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-top: 16px; }
    .hidden { display: none !important; }

    /* Gate */
    .gate { display: grid; gap: 10px; max-width: 520px; margin: 24px auto 0 auto; padding: 22px 16px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
    input[type="password"], textarea {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0f1117; color: var(--fg); font-size: 14px; outline: none;
    }
    button { padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); background: #171a22; color: var(--fg); font-size: 14px; cursor: pointer; }
    button.primary { background: var(--accent); color: #0b1020; border-color: #4f85e9; font-weight: 600; }
    .muted { color: var(--muted); font-size: 13px; }

    /* Coach */
    .coach-grid { display: grid; gap: 12px; }
    .transcript {
      background: #0f1117; border: 1px solid var(--border); border-radius: 12px; padding: 12px;
      max-height: 420px; overflow: auto; display: grid; gap: 10px;
    }
    .msg { display: inline-block; max-width: 95%; padding: 10px 12px; border-radius: 12px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.45; font-size: 14px; }
    .msg.user { background: #152238; color: #e9f0ff; justify-self: end; text-align: left; }
    .msg.ai   { background: #131720; color: #e9eef5; justify-self: start; text-align: left; }
    .coach-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .links { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .links a { color: #9fd3c7; text-decoration: none; padding: 8px 10px; border-radius: 10px; background: #10211f; border: 1px solid #1d3a35; font-size: 14px; }
    .links a:hover { filter: brightness(1.08); }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="title">Fr8 Coach</h1>
      <p class="subtitle">your personal ai freight-bot</p>
    </header>

    <!-- Password Gate -->
    <section id="gatePanel" class="panel">
      <div class="gate">
        <div class="muted">Enter site password to continue</div>
        <div class="row">
          <input id="sitePass" type="password" placeholder="Site password" autocomplete="off" />
          <button class="primary" id="enterBtn">Enter</button>
        </div>
        <div id="gateMsg" class="muted"></div>
      </div>
    </section>

    <!-- Coach Panel -->
    <section id="coachPanel" class="panel hidden">
      <div class="coach-grid">
        <!-- Intake -->
        <div>
          <label class="muted" for="prompt">Ask the Coach</label>
          <textarea id="prompt" placeholder="Ask the Coach a question...
ex) what is a good social selling strategy to help get set up with Home Depot?
ex) send me leads"></textarea>
          <div class="coach-actions">
            <button class="primary" id="askBtn">Ask</button>
            <button id="clearBtn" title="Clear conversation">Clear conversation</button>
          </div>
        </div>

        <!-- Transcript -->
        <div id="transcript" class="transcript" aria-live="polite" aria-label="Conversation transcript"></div>

        <!-- Links to cards -->
        <div class="links">
          <a href="/sales.html">Sales Cards</a>
          <a href="/ops.html">Ops Cards</a>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== Minimal, robust gate & coach wiring =====
    (function () {
      const gatePanel    = document.getElementById("gatePanel");
      const coachPanel   = document.getElementById("coachPanel");
      const sitePass     = document.getElementById("sitePass");
      const enterBtn     = document.getElementById("enterBtn");
      const gateMsg      = document.getElementById("gateMsg");
      const promptEl     = document.getElementById("prompt");
      const askBtn       = document.getElementById("askBtn");
      const clearBtn     = document.getElementById("clearBtn");
      const transcriptEl = document.getElementById("transcript");

      let HISTORY = [];
      let SITE_PASSWORD = null;

      function addMsg(role, content) {
        if (!transcriptEl) return;
        HISTORY.push({ role, content });
        const div = document.createElement("div");
        div.className = `msg ${role === "assistant" ? "ai" : "user"}`;
        div.textContent = content;
        transcriptEl.appendChild(div);
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
      }

      function showGate()  { gatePanel?.classList.remove("hidden"); coachPanel?.classList.add("hidden"); }
      function showCoach() { gatePanel?.classList.add("hidden");    coachPanel?.classList.remove("hidden"); }

      async function checkPassword(pw) {
        try {
          const r = await fetch("/api/ping", { headers: { "x-site-password": pw || "" } });
          return r.ok;
        } catch { return false; }
      }

      async function onEnter() {
        const pw = (sitePass?.value || "").trim();
        if (!pw) { if (gateMsg) { gateMsg.textContent = "Enter password."; gateMsg.style.color = "#ff8b8b"; } return; }
        if (gateMsg) { gateMsg.textContent = "Checking..."; gateMsg.style.color = ""; }
        const ok = await checkPassword(pw);
        if (!ok) {
          if (gateMsg) { gateMsg.textContent = "Invalid password."; gateMsg.style.color = "#ff8b8b"; }
          return;
        }
        SITE_PASSWORD = pw;

        // Patch fetch to always send the header
        const _fetch = window.fetch.bind(window);
        window.fetch = (url, opts = {}) => {
          const headers = Object.assign({}, opts.headers, { "x-site-password": SITE_PASSWORD || "" });
          return _fetch(url, Object.assign({}, opts, { headers }));
        };

        if (gateMsg) gateMsg.textContent = "";
        showCoach();
        promptEl?.focus();
      }

      enterBtn?.addEventListener("click", onEnter);
      sitePass?.addEventListener("keydown", (e) => { if (e.key === "Enter") onEnter(); });

      askBtn?.addEventListener("click", async () => {
        const q = (promptEl?.value || "").trim();
        if (!q) return;
        addMsg("user", q);
        if (promptEl) promptEl.value = "";

        try {
          const r = await fetch("/api/coach", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: q, history: HISTORY })
          });
          const data = await r.json();
          if (data && data.reply) addMsg("assistant", data.reply);
          else if (data && data.error) addMsg("assistant", `Error: ${data.error}`);
          else addMsg("assistant", "No reply.");
        } catch {
          addMsg("assistant", "Network error.");
        }
      });

      clearBtn?.addEventListener("click", () => { HISTORY = []; if (transcriptEl) transcriptEl.innerHTML = ""; });

      // Always start gated
      showGate();
    })();
  </script>
</body>
</html>
